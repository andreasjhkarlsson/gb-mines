#include <gb/gb.h>
#include <gb/drawing.h>
#include <minesweeper.h>
#include <stdlib.h>
#include "game.h"
#include "graphics.h"
#include "utils.h"

#define GRID_WIDTH 20
#define GRID_HEIGHT 16

#define SCREEN_TILE_WIDTH 20
#define SCREEN_TILE_HEIGHT 18

#define MARKER_NB 0

TILESET(
	game_tiles,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x00, // 0
	0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x1C, 0x1C, 0x04, 0x04, 0x04, 0x04, // 1
	0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x1F, 0x1F,
	0x00, 0x00, 0x3C, 0x3C, 0x04, 0x04, 0x04, 0x04, // 2
	0x3C, 0x3C, 0x20, 0x20, 0x20, 0x20, 0x3C, 0x3C,
	0x00, 0x00, 0x3C, 0x3C, 0x04, 0x04, 0x04, 0x04, // 3
	0x3C, 0x3C, 0x04, 0x04, 0x04, 0x04, 0x3C, 0x3C,
	0x00, 0x00, 0x24, 0x24, 0x24, 0x24, 0x24, 0x24, // 4
	0x3C, 0x3C, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
	0x00, 0x00, 0x3C, 0x3C, 0x20, 0x20, 0x20, 0x20, // 5
	0x3C, 0x3C, 0x04, 0x04, 0x04, 0x04, 0x3C, 0x3C,
	0x00, 0x00, 0x3C, 0x3C, 0x20, 0x20, 0x20, 0x20, // 6
	0x3C, 0x3C, 0x24, 0x24, 0x24, 0x24, 0x3C, 0x3C,
	0x00, 0x00, 0x3C, 0x3C, 0x04, 0x04, 0x04, 0x04, // 7
	0x0E, 0x0E, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
	0x00, 0x00, 0x3C, 0x3C, 0x24, 0x24, 0x24, 0x24, // 8
	0x3C, 0x3C, 0x24, 0x24, 0x24, 0x24, 0x3C, 0x3C,
	0x00, 0x00, 0x00, 0x7E, 0x00, 0x7E, 0x00, 0x7E, // Unopened
	0x00, 0x7E, 0x00, 0x7E, 0x00, 0x7E, 0x00, 0x00,
	0x00, 0x00, 0x08, 0x08, 0x18, 0x18, 0x38, 0x38, // Flagged
	0x18, 0x18, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00,
	0x18, 0x18, 0x24, 0x3C, 0x7E, 0x5A, 0xBD, 0xFF, // Mine
	0xBD, 0xFF, 0x7E, 0x5A, 0x24, 0x3C, 0x18, 0x18,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, // Black
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // White
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
);

TILESET(
	select_to_view_tiles,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xC3, 0xC3, 0x81, 0x81, 0x89, 0x89,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x83, 0x83, 0x83, 0x83, 0x8F, 0x8F,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x1C, 0x1C, 0x1C, 0x1C, 0x1C, 0x1C,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x1C, 0x1C, 0x18, 0x18, 0x78, 0x78,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x18, 0x18, 0x08, 0x08, 0x8E, 0x8E,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x0E, 0x0E, 0x0E, 0x0E, 0x3F, 0x3F,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x03, 0x03, 0x03, 0x03, 0x8E, 0x8E,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x07, 0x07, 0x07, 0x07, 0x23, 0x23,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x31, 0x31, 0x31, 0x31, 0x31, 0x31,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x82, 0x82, 0x82, 0x82, 0x8E, 0x8E,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x8F, 0x8F, 0x8F, 0x8F, 0x8F, 0x8F,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x03, 0x03, 0x01, 0x01, 0x11, 0x11,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xC1, 0xC1, 0xC1, 0xC1, 0x88, 0x88,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xE3, 0xE3, 0xE3, 0xE3, 0xE9, 0xE9,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x81, 0x81, 0x80, 0x80, 0x88, 0x88,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xC0, 0xC0, 0xC0, 0xC0, 0xC4, 0xC4,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x7F, 0x7F, 0x7F,
	0x89, 0x89, 0x8F, 0x8F, 0x87, 0x87, 0xC3, 0xC3, 0xE1, 0xE1, 0xF1, 0xF1, 0x91, 0x91, 0x91, 0x91,
	0x8F, 0x8F, 0x8F, 0x8F, 0x83, 0x83, 0x83, 0x83, 0x8F, 0x8F, 0x8F, 0x8F, 0x8F, 0x8F, 0x8F, 0x8F,
	0x1C, 0x1C, 0x1C, 0x1C, 0x1C, 0x1C, 0x1C, 0x1C, 0x1C, 0x1C, 0x1C, 0x1C, 0x1C, 0x1C, 0x1C, 0x1C,
	0x78, 0x78, 0x78, 0x78, 0x18, 0x18, 0x18, 0x18, 0x78, 0x78, 0x78, 0x78, 0x78, 0x78, 0x78, 0x78,
	0x8E, 0x8E, 0x8E, 0x8E, 0xFE, 0xFE, 0xFE, 0xFE, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E,
	0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F,
	0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E,
	0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23,
	0xC4, 0xC4, 0xC4, 0xC4, 0xC4, 0xC4, 0xC4, 0xC4, 0xC4, 0xC4, 0xC4, 0xC4, 0xE4, 0xE4, 0xE0, 0xE0,
	0x71, 0x71, 0x71, 0x71, 0x71, 0x71, 0x71, 0x71, 0x71, 0x71, 0x71, 0x71, 0xF1, 0xF1, 0xF1, 0xF1,
	0x11, 0x11, 0x11, 0x11, 0x15, 0x15, 0x15, 0x15, 0x15, 0x15, 0x15, 0x15, 0x95, 0x95, 0x84, 0x84,
	0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x3F, 0x3F, 0x3F, 0x3F,
	0x11, 0x11, 0x11, 0x11, 0x07, 0x07, 0x01, 0x01, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
	0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88,
	0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0x8C, 0x8C, 0x80, 0x80, 0x80, 0x80,
	0x88, 0x88, 0x88, 0x88, 0x80, 0x80, 0x81, 0x81, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88,
	0xC4, 0xC4, 0xC4, 0xC4, 0xC4, 0xC4, 0xC4, 0xC4, 0xC4, 0xC4, 0xC4, 0xC4, 0xC4, 0xC4, 0xC4, 0xC4,
	0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F,
	0x81, 0x81, 0xC3, 0xC3, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0x81, 0x81, 0x81, 0x81, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0x04, 0x04, 0x04, 0x04, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0x08, 0x08, 0x0C, 0x0C, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0x1E, 0x1E, 0x3E, 0x3E, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0x3F, 0x3F, 0x3F, 0x3F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0x8F, 0x8F, 0x8F, 0x8F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0x03, 0x03, 0x07, 0x07, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xE0, 0xE0, 0xE0, 0xE0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xF1, 0xF1, 0xF1, 0xF1, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0x8E, 0x8E, 0x8E, 0x8E, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0x01, 0x01, 0x03, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xC0, 0xC0, 0xC1, 0xC1, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0x9C, 0x9C, 0x9C, 0x9C, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0x88, 0x88, 0x88, 0x88, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xC0, 0xC0, 0xC0, 0xC0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0x7F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF
);

TILEMAP(select_to_view_map, 20, 3,
	0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0A, 0x0B, 0x0A, 0x0C, 0x0D, 0x0E,
	0x0F, 0x10, 0x11, 0x12, 0x00, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x1A, 0x1B, 0x1C, 0x14,
	0x1D, 0x1E, 0x1F, 0x20, 0x21, 0x22, 0x23, 0x24, 0x00, 0x25, 0x26, 0x27, 0x28, 0x29, 0x2A, 0x2B,
	0x2C, 0x2D, 0x2E, 0x26, 0x2F, 0x2A, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35
);

TILESET(
	footer_tileset,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x04, 0x04, 0x04, 0x07, 0x07, 0x07, 0x07, 0x04, 0x04,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x9D, 0x9D, 0x89, 0x89, 0x89, 0x89, 0x89, 0x89, 0x89, 0x89,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x2F, 0x2F, 0x28, 0x28, 0xA8, 0xA8, 0xA8, 0xA8, 0x6F, 0x6F,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x48, 0x48, 0x48, 0x48, 0x40, 0x40, 0x30, 0x30,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x0F, 0x0F,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x41, 0x41, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x43, 0x43,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x8C, 0x8C, 0x52, 0x52, 0x52, 0x52, 0x50, 0x50, 0xD0, 0xD0,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x60, 0x90, 0x90, 0x90, 0x90, 0x80, 0x80, 0x60, 0x60,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1F, 0x1F, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x74, 0x74, 0x24, 0x24, 0x27, 0x27, 0x27, 0x27, 0x24, 0x24,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xBC, 0xBC, 0xA0, 0xA0, 0xA0, 0xA0, 0xA0, 0xA0, 0xBC, 0xBC,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x89, 0x89, 0x89, 0x89, 0x89, 0x89, 0x9D, 0x9D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x68, 0x68, 0x28, 0x28, 0x28, 0x28, 0x2F, 0x2F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x08, 0x08, 0x48, 0x48, 0x48, 0x48, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x7A, 0x7A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x56, 0x56, 0x52, 0x52, 0x52, 0x52, 0x4C, 0x4C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x10, 0x10, 0x90, 0x90, 0x90, 0x90, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x24, 0x24, 0x24, 0x24, 0x24, 0x24, 0x74, 0x74, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0xA0, 0xA0, 0xA0, 0xA0, 0xA0, 0xA0, 0xBC, 0xBC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
);

TILEMAP(
	footer_tilemap,
	20,2,
	0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F,
	0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x1A, 0x1B, 0x1C, 0x1D, 0x1E, 0x1F,
	0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27
);


TILESET(
	double_row_digits_tileset,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1C, 0x1C, 0x24, 0x24, 0x24, 0x24, 0x24, 0x24, 0x24, 0x24,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x08, 0x18, 0x18, 0x28, 0x28, 0x08, 0x08, 0x08, 0x08,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x24, 0x24, 0x24, 0x24, 0x04, 0x04, 0x08, 0x08,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x24, 0x24, 0x04, 0x04, 0x04, 0x04, 0x18, 0x18,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x04, 0x0C, 0x0C, 0x14, 0x14, 0x14, 0x14, 0x24, 0x24,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x3C, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x38, 0x38,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x10, 0x10, 0x20, 0x20, 0x38, 0x38, 0x24, 0x24,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x3C, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x08, 0x08,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x24, 0x24, 0x24, 0x24, 0x24, 0x24, 0x18, 0x18,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x24, 0x24, 0x24, 0x24, 0x24, 0x24, 0x24, 0x24,
	0x24, 0x24, 0x24, 0x24, 0x24, 0x24, 0x38, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x3C, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x10, 0x10, 0x20, 0x20, 0x20, 0x20, 0x3C, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x04, 0x04, 0x04, 0x04, 0x24, 0x24, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x3C, 0x3C, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x04, 0x04, 0x04, 0x04, 0x24, 0x24, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x24, 0x24, 0x24, 0x24, 0x24, 0x24, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x08, 0x08, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x24, 0x24, 0x24, 0x24, 0x24, 0x24, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x1C, 0x1C, 0x04, 0x04, 0x08, 0x08, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
);

TILESET(
	start_footer_tileset,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE7, 0xE7, 0x94, 0x94, 0x94, 0x94, 0x94, 0x94, 0xE7, 0xE7,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xA4, 0xA4, 0x24, 0x24, 0x34, 0x34, 0x34, 0x34, 0xAC, 0xAC,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x06, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x0F, 0x0F,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x4A, 0x4A, 0x4A, 0x4A, 0x6A, 0x6A, 0x69, 0x69, 0x59, 0x59,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x40, 0x40, 0x40, 0x40,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFB, 0xFB, 0x21, 0x21, 0x21, 0x21, 0x21, 0x21, 0x21, 0x21,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xA1, 0xA1, 0x21, 0x21, 0x21, 0x21, 0x21, 0x21, 0x21, 0x21,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xE0,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7D, 0x7D, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x67, 0x67, 0x91, 0x91, 0x91, 0x91, 0x81, 0x81, 0x61, 0x61,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xD9, 0xD9, 0x25, 0x25, 0x25, 0x25, 0x25, 0x25, 0x3D, 0x3D,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xCF, 0xCF, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0xC2, 0xC2,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x83, 0x83, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF2, 0xF2, 0x92, 0x92, 0x92, 0x92, 0x92, 0x92, 0x9E, 0x9E,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xF0, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xF0, 0xF0,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x25, 0x25, 0x25, 0x25, 0x21, 0x21, 0x21, 0x21,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC9, 0xC9, 0x29, 0x29, 0x2F, 0x2F, 0x2F, 0x2F, 0xE9, 0xE9,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x78, 0x78, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x78, 0x78,
	0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x0C, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x84, 0x84, 0x84, 0x84, 0x84, 0x84, 0x87, 0x87, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x2C, 0x2C, 0x24, 0x24, 0x24, 0x24, 0xA4, 0xA4, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x58, 0x58, 0x48, 0x48, 0x48, 0x48, 0x48, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x21, 0x21, 0x21, 0x21, 0x21, 0x21, 0x23, 0x23, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x21, 0x21, 0x21, 0x21, 0x21, 0x21, 0xBD, 0xBD, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x11, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x11, 0x11, 0x91, 0x91, 0x91, 0x91, 0x61, 0x61, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x25, 0x25, 0x25, 0x25, 0x25, 0x25, 0x25, 0x25, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x82, 0x82, 0x42, 0x42, 0x22, 0x22, 0x22, 0x22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x92, 0x92, 0x92, 0x92, 0x92, 0x92, 0x92, 0x92, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xF0, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x2D, 0x2D, 0x25, 0x25, 0x25, 0x25, 0x19, 0x19, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x29, 0x29, 0x29, 0x29, 0x29, 0x29, 0x29, 0x29, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x78, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
);

TILEMAP(
	start_footer_tilemap,
	20, 2,
	0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F,
	0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x1A, 0x1B, 0x1C, 0x1D, 0x1E, 0x1F,
	0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27
);

unsigned char sprites[] =
{
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // Empty
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0xFF,0xFF,0x81,0x81,0x81,0x81,0x81,0x81, // Marker
	0x81,0x81,0xC1,0x81,0xA1,0xC1,0xFF,0xFF
};

// Offsets in game_tiles
enum tile {
	Zero = 0,
	One = 1,
	Two = 2,
	Three = 3,
	Four = 4,
	Five = 5,
	Six = 6,
	Seven = 7,
	Eight = 8,
	Unopened = 9,
	Flagged = 10,
	Mine = 11,
	Black = 12,
	White = 13
};

// Digit to tile offset in game_tiles
uint8_t digit_to_tile(uint8_t digit)
{
	return (uint8_t)digit; // Actually the same for now.
}

void move_marker(int16_t x, int16_t y)
{
	move_sprite(MARKER_NB, (SCREENWIDTH / SCREEN_TILE_WIDTH) * (x+1), (SCREENHEIGHT / SCREEN_TILE_HEIGHT) * (y+2));
}

void show_marker()
{
	set_sprite_tile(MARKER_NB, 1);
}

void hide_marker()
{
	set_sprite_tile(MARKER_NB, 0);
}

struct loaded_tileset* loaded_game_tiles;

void set_tile(int16_t x, int16_t y, uint8_t tile)
{
	place_tile(loaded_game_tiles, tile, x, y);
}

void show_double_row_digit(uint8_t digit, uint8_t x, uint8_t y)
{
	struct loaded_tileset* digits = load_tileset(&double_row_digits_tileset);
	place_tile(digits, digit, x, y);
	place_tile(digits, 10 + digit, x, y + 1);
}

void show_mine_count(uint16_t mines)
{
	show_double_row_digit((mines / 100) % 10, 4, SCREEN_TILE_HEIGHT-2);
	show_double_row_digit((mines / 10) % 10, 5, SCREEN_TILE_HEIGHT-2);
	show_double_row_digit(mines % 10, 6, SCREEN_TILE_HEIGHT-2);
}

void show_flag_count(uint16_t flags)
{
	show_double_row_digit((flags / 100) % 10, 11, SCREEN_TILE_HEIGHT-2);
	show_double_row_digit((flags / 10) % 10, 12, SCREEN_TILE_HEIGHT-2);
	show_double_row_digit(flags % 10, 13, SCREEN_TILE_HEIGHT-2);
}



void show_time(uint16_t time)
{
	show_double_row_digit((time / 100) % 10, 17, SCREEN_TILE_HEIGHT-2);
	show_double_row_digit((time / 10) % 10, 18, SCREEN_TILE_HEIGHT-2);
	show_double_row_digit(time % 10, 19, SCREEN_TILE_HEIGHT-2);
}


void show_won_game()
{
	// Monotone bitmap where every element is row on screen.
	// LSB is bottom of screen.
	static const unsigned long bitmap[] = {
		0x0000, 0x0000, 0x0F00, 0x30C0, 0x5020,
		0x5220, 0xBB10, 0xBA90, 0x13A48, 0x11248,
		0x11248, 0x13A48, 0xBA90, 0xBB10, 0x5220,
		0x5020, 0x30C0, 0x0F00, 0x0000, 0x000
	};

	int16_t y, x;
	for (y = 0;y < SCREEN_TILE_HEIGHT; y++)
	{
		for (x = 0;x < SCREEN_TILE_WIDTH;x++)
		{
			int8_t bit = (bitmap[x] >> ((SCREEN_TILE_HEIGHT - 1) - y)) & 1;
			place_tile(loaded_game_tiles, bit ? White : Black, x, y);
		}
		delay(75);
	}
}

void show_game_over()
{
	// Monotone bitmap where every element is row on screen.
	// LSB is bottom of screen.
	static const uint32_t bitmap[] = {
		0x0000, 0x7DF0, 0x4510, 0x5510, 0x5DF0,
		0x0000, 0x3DE0, 0x4810, 0x3DE0, 0x0000,
		0x7DF0, 0x4150, 0x3110, 0x4000, 0x7DF0,
		0x0140, 0x7DB0, 0x5400, 0x45D0, 0x0000
	};
	int16_t sx = 0; // Spiral coordinates calculated from center
	int16_t sy = 0;
	int32_t i;

	// Spiral.
	for (i = 0; i < SCREEN_TILE_WIDTH*SCREEN_TILE_WIDTH; i++)
	{
		int16_t x = SCREEN_TILE_WIDTH / 2 + sx - 1;
		int16_t y = SCREEN_TILE_HEIGHT / 2 + sy;
		int8_t bit = (bitmap[x] >> ((SCREEN_TILE_HEIGHT-1)-y)) & 1;
		set_tile(x,y, bit ? White : Black);

		if (abs(sx) <= abs(sy) && (sx != sy || sx >= 0))
			sx += ((sy >= 0) ? 1 : -1);
		else
			sy += ((sx >= 0) ? -1 : 1);

		delay(5);
	}
}

void load_tiles()
{
	// Background tiles
	loaded_game_tiles = load_tileset(&game_tiles);

	// Sprite tiles
	set_sprite_data(0, 2, sprites);
}

void show_select_to_view()
{
	struct loaded_tileset* loaded_tileset = load_tileset(&select_to_view_tiles);
	place_tiles(loaded_tileset, &select_to_view_map, 0, SCREEN_TILE_HEIGHT - select_to_view_map.height);
}

void render_start_footer()
{
	place_tiles(load_tileset(&start_footer_tileset), &start_footer_tilemap, 0, SCREEN_TILE_HEIGHT-2);
}

void render_footer()
{
	place_tiles(load_tileset(&footer_tileset), &footer_tilemap, 0, SCREEN_TILE_HEIGHT-2);
}

static uint16_t game_time;

// Called 16 times / second
void on_timer_overflow()
{
	game_time++;
}

void start_timer()
{
	disable_interrupts();
	add_TIM(on_timer_overflow);
	TAC_REG = 4; // Start timer at 4096 Hz
	TIMA_REG = 0; // Reset timer
	TMA_REG = 0; // Restart timer at 0 on overflow
	game_time = 0;
	enable_interrupts();
	set_interrupts(TIM_IFLAG|VBL_IFLAG);
}

void stop_timer()
{
	disable_interrupts();
	remove_TIM(on_timer_overflow);
	TAC_REG = 0;
	enable_interrupts();
}

void render_tile(struct minesweeper_game* game, struct minesweeper_tile* tile, void* context)
{
	uint8_t sprite;
	unsigned x, y; minesweeper_get_tile_location(game, tile, &x, &y);

	if (tile->has_mine && (tile->is_opened || game->state == MINESWEEPER_GAME_OVER))
		sprite = Mine;
	else if (tile->is_opened)
		sprite = digit_to_tile(tile->adjacent_mine_count);
	else if (tile->has_flag)
	{
		sprite = Flagged;
	}
	else
		sprite = Unopened;

	set_tile(x, y, sprite);
}

void render_all_tiles(struct minesweeper_game* game, bool mines_only)
{
	struct minesweeper_tile *tile;
	unsigned x, y;
	for (x = 0;x < game->width;x++)
	{
		for (y = 0; y < game->height;y++)
		{
			tile = minesweeper_get_tile_at(game, x, y);
			if (mines_only && !tile->has_mine)
				continue;
			render_tile(game, tile, NULL);
		}
	}
}

static unsigned char tilemap_buffer[SCREEN_TILE_WIDTH*SCREEN_TILE_HEIGHT];
static uint16_t display_time;

void update_hud(struct minesweeper_game* game)
{
	show_flag_count(game->flag_count);
	show_mine_count(game->mine_count);
	show_time(display_time);
}

struct navigation
{
	uint8_t button;
	enum direction direction;
	uint16_t hold; // Number of iterations in a row the button has been pressed
};

void handle_navigation(struct minesweeper_game* game, struct navigation* navigation)
{
	if (button_pressed(navigation->button, 0))
	{
		// Immediately respond to first press, but then wait 8 iters before
		// moving again if the button is not released
		if (navigation->hold == 0 || navigation->hold > 8)
			minesweeper_move_cursor(game, navigation->direction, true);
		navigation->hold += 1;
	}
	else
	{
		navigation->hold = 0;
	}
}

void play_game(int8_t difficulty)
{
	struct navigation navigations[4] = {
		{ .button = J_UP,    .direction = UP,    .hold = 0 },
		{ .button = J_DOWN,  .direction = DOWN,  .hold = 0 },
		{ .button = J_LEFT,  .direction = LEFT,  .hold = 0 },
		{ .button = J_RIGHT, .direction = RIGHT, .hold = 0 }
	};
	unsigned x, y;
	unsigned i;
	struct minesweeper_game* game;
	uint8_t *game_memory = malloc(minesweeper_minimum_buffer_size(GRID_WIDTH, GRID_HEIGHT));
	
	game_time = 0;
	display_time = 0;

	game = minesweeper_init(GRID_WIDTH, GRID_HEIGHT, 0.1 * (difficulty+1), game_memory);
	game->tile_update_callback = render_tile;
	minesweeper_set_cursor(game, GRID_WIDTH / 2, GRID_HEIGHT / 2);
	
	// Prepare graphics
	load_tiles();
	show_marker();

	SHOW_BKG;
	SHOW_SPRITES;
	SPRITES_8x8;

	update_hud(game);
	render_start_footer();

	render_all_tiles(game, false);

	while (game->state != MINESWEEPER_GAME_OVER && game->state != MINESWEEPER_WIN)
	{
		disable_interrupts();

		for (i = 0; i < sizeof(navigations) / sizeof(navigations[0]); i += 1)
			handle_navigation(game, &navigations[i]);

		if (button_pressed(J_A, -1))
		{
			if (game->state == MINESWEEPER_PENDING_START)
			{
				render_footer();
				show_time(0);
				start_timer();
			}

			minesweeper_open_tile(game, game->selected_tile);
			update_hud(game);
		}
		if (button_pressed(J_B, -1))
		{
			minesweeper_toggle_flag(game, game->selected_tile);
			update_hud(game);
		}

		minesweeper_get_tile_location(game, game->selected_tile, &x, &y);
		move_marker(x, y);

		if (display_time != game_time/16)
		{
			display_time = game_time/16;
			update_hud(game);
		}

		enable_interrupts();
		delay(50);
	}

	stop_timer();
	hide_marker();
	

	if (game->state == MINESWEEPER_GAME_OVER)
    {
		render_all_tiles(game, true);
    }

	// Save current tilemap
	get_bkg_tiles(0, 0, SCREEN_TILE_WIDTH, SCREEN_TILE_HEIGHT, tilemap_buffer);

	if (game->state == MINESWEEPER_WIN)
		show_won_game();
	else if (game->state == MINESWEEPER_GAME_OVER)
		show_game_over();

	// Add text to above screens
	show_select_to_view();

	while (1)
	{
		// While user presses select, temporarily show saved tilemap
		if (button_pressed(J_SELECT, 0))
		{
			push_graphics();
			set_bkg_tiles(0, 0, SCREEN_TILE_WIDTH, SCREEN_TILE_HEIGHT, tilemap_buffer);
			while (button_pressed(J_SELECT, 0));
			pop_graphics();
		}
		if (button_pressed(J_START, -1) || button_pressed(J_A, -1))
			break;
	}

	free(game_memory);
}
